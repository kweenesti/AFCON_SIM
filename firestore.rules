
/**
 * @file Firestore Security Rules for African Nations Tournament Simulator
 * @description This ruleset enforces a user-ownership model for federations and their associated player data, while allowing public read access to country data.
 *
 * Data Structure:
 * - /countries/{countryId}: Publicly accessible data about countries.
 * - /users/{userId}: User profile data, readable only by the owning user.
 * - /federations/{federationId}: Federation data, accessible only to the authenticated user with the matching federationId.
 * - /federations/{federationId}/players/{playerId}: Player data nested under federations, accessible only to the owning federation.
 * - /tournaments/{tournamentId}: Tournament data. Can only be created by admins, but readable by all.
 * - /matches/{matchId}: Match data. Can only be created/updated by admins, readable by all.
 *
 * Key Security Decisions:
 * - Countries are publicly readable.
 * - User profiles are private and can only be read by the owner.
 * - Federations are owned by individual users; only the owner can create, read, update, or delete their federation data.
 * - Players are owned by their parent federation; only the owning federation can create, read, update, or delete player data.
 * - Tournaments can only be created by admins, ensuring controlled tournament management.
 * - Matches can only be created and updated by admins.
 * - Authorization independence is achieved by denormalizing `federationId` into the `Player` documents.
 * - Data validation is limited to authorization-critical fields (e.g., `federationId` on Player creation).
 * - Listing of federations is disallowed for security. Listing of players is only allowed for the owner.
 *
 * Denormalization for Authorization:
 * - The `Player` documents contain a denormalized `federationId` field, which matches the parent federation's document ID. This allows direct authorization checks without needing to perform additional `get()` calls.
 *
 * Structural Segregation:
 * - Public `Country` data is stored in a top-level collection, while private `User`, `Federation`, and `Player` data are stored in separate collections or hierarchical structures. This segregation simplifies access control and improves performance.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    /**
     * @description Allows anyone to read country data. No write access allowed.
     * @path /countries/{countryId}
     * @allow (get, list) - Any user can read country data.
     * @deny (create, update, delete) - No one can create, update, or delete country data.
     * @principle Allows public read access to country data.
     */
    match /countries/{countryId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Enforces user-ownership for user profile data.
     * @path /users/{userId}
     * @allow (get) - An authenticated user can read their own user profile.
     * @deny (list, create, update, delete) - Users cannot list, create, update, or delete profiles directly.
     * @principle Enforces document ownership for reads.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth.uid == userId;
      }
      allow get: if isSignedIn() && isOwner(userId);
      // Admin can update any user's role
      allow update: if isAdmin();
      allow list, create, delete: if false;
    }

    /**
     * @description Enforces user-ownership for federation data. Only the authenticated user with a matching federationId can read, create, update, or delete their own federation data.
     * @path /federations/{federationId}
     * @allow (create) - Authenticated user 'user_abc' can create a federation with ID 'user_abc'.
     * @allow (get, update, delete) - Authenticated user 'user_abc' can read, update, or delete their federation with ID 'user_abc'.
     * @deny (create, get, update, delete) - Authenticated user 'user_xyz' cannot create, read, update, or delete federation data for 'user_abc'.
     * @principle Enforces document ownership for writes.
     */
    match /federations/{federationId} {
      function isOwner(federationId) {
        return request.auth.uid == federationId;
      }

      function isExistingOwner(federationId) {
        return isOwner(federationId) && resource != null;
      }
      allow create: if isSignedIn() && isOwner(federationId);
      allow get: if true;
      allow list: if isAdmin();
      allow update: if isExistingOwner(federationId);
      allow delete: if isExistingOwner(federationId);
    }

    /**
     * @description Enforces user-ownership for player data nested under federations. Only the owning federation can create, read, update, or delete player data. The 'federationId' is denormalized into each Player document to avoid requiring a get() call to the parent document.
     * @path /federations/{federationId}/players/{playerId}
     * @allow (create) - Authenticated user 'user_abc' can create a player under federation 'user_abc' if the player document's federationId also equals 'user_abc'.
     * @allow (get, list, update, delete) - Authenticated user 'user_abc' can read, list, update, or delete players under federation 'user_abc'.
     * @deny (create, get, list, update, delete) - Authenticated user 'user_xyz' cannot create, read, update, or delete player data under federation 'user_abc'.
     * @principle Enforces document ownership for writes, validates relational integrity on create, and prevents modification of the federationId.
     */
    match /federations/{federationId}/players/{playerId} {
      function isOwner(federationId) {
        return request.auth.uid == federationId;
      }

       function isExistingOwner(federationId) {
        return isOwner(federationId) && resource != null;
      }

      // Allow admins and owners to list players
      allow list: if isOwner(federationId) || isAdmin();
      allow create: if isSignedIn() && isOwner(federationId) && request.resource.data.federationId == federationId;
      allow get: if isOwner(federationId) || isAdmin();
      allow update: if isExistingOwner(federationId) && request.resource.data.federationId == resource.data.federationId;
      allow delete: if isExistingOwner(federationId);
    }

    /**
     * @description Manages access to tournament data.
     * @path /tournaments/{tournamentId}
     * @allow (create) - Only authenticated users with an 'admin' role can create new tournaments.
     * @allow (get, list) - All users can read tournament information.
     * @allow (delete) - Only admins can delete tournaments (for restarting).
     * @deny (update) - Tournaments cannot be updated through the client SDK.
     * @principle Secures tournament creation and deletion to admins while allowing public read access.
     */
    match /tournaments/{tournamentId} {
      allow create, delete: if isAdmin();
      allow get, list: if true;
      allow update: if false;
    }

    /**
     * @description Manages access to match data.
     * @path /matches/{matchId}
     * @allow (create, update, delete) - Only admins can create, update, and delete matches.
     * @allow (get, list) - All users (including non-authenticated) can read match data.
     * @principle Secures match management to admins while allowing public viewing.
     */
    match /matches/{matchId} {
        allow create, update, delete: if isAdmin();
        allow get, list: if true;
    }
  }
}
