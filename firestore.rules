/**
 * @file Firestore Security Rules for African Nations Tournament Simulator
 * @description This ruleset enforces a user-ownership model for federations and their associated player data, while allowing public read access to country data.
 *
 * Data Structure:
 * - /countries/{countryId}: Publicly accessible data about countries.
 * - /federations/{federationId}: Federation data, accessible only to the authenticated user with the matching federationId.
 * - /federations/{federationId}/players/{playerId}: Player data nested under federations, accessible only to the owning federation.
 *
 * Key Security Decisions:
 * - Countries are publicly readable.
 * - Federations are owned by individual users; only the owner can create, read, update, or delete their federation data.
 * - Players are owned by their parent federation; only the owning federation can create, read, update, or delete player data.
 * - Authorization independence is achieved by denormalizing `federationId` into the `Player` documents.
 * - Data validation is limited to authorization-critical fields (e.g., `federationId` on Player creation).
 * - Listing of federations is disallowed for security. Listing of players is only allowed for the owner.
 *
 * Denormalization for Authorization:
 * - The `Player` documents contain a denormalized `federationId` field, which matches the parent federation's document ID. This allows direct authorization checks without needing to perform additional `get()` calls.
 *
 * Structural Segregation:
 * - Public `Country` data is stored in a top-level collection, while private `Federation` and `Player` data are stored in a hierarchical structure. This segregation simplifies access control and improves performance.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read country data. No write access allowed.
     * @path /countries/{countryId}
     * @allow (get, list) - Any user can read country data.
     * @deny (create, update, delete) - No one can create, update, or delete country data.
     * @principle Allows public read access to country data.
     */
    match /countries/{countryId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Enforces user-ownership for federation data. Only the authenticated user with a matching federationId can read, create, update, or delete their own federation data.
     * @path /federations/{federationId}
     * @allow (create) - Authenticated user 'user_abc' can create a federation with ID 'user_abc'.
     * @allow (get, update, delete) - Authenticated user 'user_abc' can read, update, or delete their federation with ID 'user_abc'.
     * @deny (create, get, update, delete) - Authenticated user 'user_xyz' cannot create, read, update, or delete federation data for 'user_abc'.
     * @principle Enforces document ownership for writes.
     */
    match /federations/{federationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(federationId) {
        return request.auth.uid == federationId;
      }

      function isExistingOwner(federationId) {
        return isOwner(federationId) && resource != null;
      }
      allow create: if isSignedIn() && isOwner(federationId);
      allow get: if isOwner(federationId);
      allow update: if isExistingOwner(federationId);
      allow delete: if isExistingOwner(federationId);
      allow list: if false;
    }

    /**
     * @description Enforces user-ownership for player data nested under federations. Only the owning federation can create, read, update, or delete player data. The 'federationId' is denormalized into each Player document to avoid requiring a get() call to the parent document.
     * @path /federations/{federationId}/players/{playerId}
     * @allow (create) - Authenticated user 'user_abc' can create a player under federation 'user_abc' if the player document's federationId also equals 'user_abc'.
     * @allow (get, list, update, delete) - Authenticated user 'user_abc' can read, list, update, or delete players under federation 'user_abc'.
     * @deny (create, get, list, update, delete) - Authenticated user 'user_xyz' cannot create, read, update, or delete player data under federation 'user_abc'.
     * @principle Enforces document ownership for writes, validates relational integrity on create, and prevents modification of the federationId.
     */
    match /federations/{federationId}/players/{playerId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(federationId) {
        return request.auth.uid == federationId;
      }

       function isExistingOwner(federationId) {
        return isOwner(federationId) && resource != null;
      }

      allow create: if isSignedIn() && isOwner(federationId) && request.resource.data.federationId == federationId;
      allow get: if isOwner(federationId);
      allow list: if isOwner(federationId);
      allow update: if isExistingOwner(federationId) && request.resource.data.federationId == resource.data.federationId;
      allow delete: if isExistingOwner(federationId);
    }
  }
}